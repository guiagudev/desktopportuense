<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Eventos</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FullCalendar Styles -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.css"
      rel="stylesheet"
    />

    <!-- jQuery y FullCalendar Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.js"></script>

    <!-- FullCalendar Español (es) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/locale/es.js"></script>

    <style>
      #calendar {
        width: 80%;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <header class="card-header">
      <a href="jugadores.html">Volver al listado de Jugadores</a>
    </header>

    <!-- Contenedor para el Calendario -->
    <div class="container">
      <h1 class="my-4 text-center">Calendario de Partidos</h1>
      <div id="calendar"></div>
    </div>

    <!-- Modal para crear evento -->
  <!-- Modal para crear o editar evento -->
<div
id="createEventModal"
class="modal fade"
tabindex="-1"
role="dialog"
aria-labelledby="createEventModalLabel"
aria-hidden="true"
>
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="createEventModalLabel">Crear Evento</h5>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
      ></button>
    </div>
    <div class="modal-body">
      <form id="createEventForm">
        <div class="mb-3">
          <label for="equipo1" class="form-label">Equipo 1</label>
          <input
            type="text"
            class="form-control"
            id="equipo1"
            value="Portuense F.C."
            required
          />
        </div>
        <div class="mb-3">
          <label for="equipo2" class="form-label">Equipo 2</label>
          <input type="text" class="form-control" id="equipo2" required />
        </div>
        <div class="mb-3">
          <label for="eventDescription" class="form-label"
            >Descripción</label
          >
          <textarea
            class="form-control"
            id="eventDescription"
            rows="3"
            required
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="eventDate" class="form-label">Fecha</label>
          <input
            type="datetime-local"
            class="form-control"
            id="eventDate"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary">
          Crear Evento
        </button>
      </form>
      
      <!-- Botón para eliminar evento -->
      <button id="deleteEventBtn" class="btn btn-danger mt-3">
        Eliminar Evento
      </button>
    </div>
  </div>
</div>
</div>

    <script>
      const apiUrlEventos = "http://127.0.0.1:8000/api/eventos/";

      $(document).ready(function () {
        $("#calendar").fullCalendar({
  locale: "es", // Configuración del idioma en español
  header: {
    left: "prev,next today",
    center: "title",
    right: "month,agendaWeek,agendaDay",
  },
  events: async function (start, end, timezone, callback) {
    try {
      const token = await window.api.getToken();
      const response = await fetch(apiUrlEventos, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: token ? `Bearer ${token}` : "",
        },
      });

      if (!response.ok) {
        throw new Error("Error al cargar los eventos");
      }

      const data = await response.json();
      
      const eventos = data.map((evento) => ({
        title: `${evento.equipo1} vs ${evento.equipo2}`,
        start: evento.fecha,
        description: evento.descripcion,
        id: evento.id,
        color: evento.equipo1 === "Portuense F.C." || evento.equipo2 === "Portuense F.C." ? "#FF5733" : "#007bff",
      }));

      callback(eventos);
    } catch (error) {
      console.error("Error al cargar los eventos:", error);
    }
  },
  eventRender: function (event, element) {
    // Aplica el color al evento desde la propiedad 'color'
    element.css("background-color", event.color);
  },
  eventClick: function (event) {
    // Abrir el modal de edición de evento
    if (event && event.start) {
    // Abrir el modal de edición de evento
    $("#createEventModal").modal("show");

    // Cargar los datos del evento en el modal
    $("#eventTitle").val(event.title);
    $("#eventDescription").val(event.description);
    $("#eventStart").val(event.start.format("YYYY-MM-DDTHH:mm"));
    $("#eventEnd").val(event.end ? event.end.format("YYYY-MM-DDTHH:mm") : event.start.format("YYYY-MM-DDTHH:mm")); // Si no tiene 'end', se usa el 'start' como final
    
    // Guardar el ID del evento para poder editar o borrar
    $("#createEventForm").data("eventId", event.id);

    // Mostrar el botón de eliminar en el modal
    $("#deleteEventBtn").show();
  } else {
    console.error("El evento no está definido correctamente.");
  }
  },
  editable: true,
  droppable: true,
  dayClick: function (date, jsEvent, view) {
    // Abre el modal de creación de evento
    $("#createEventModal").modal("show");

    // Rellenamos las fechas de inicio y fin con la fecha clicada
    $("#eventStart").val(date.format("YYYY-MM-DDTHH:mm"));
    $("#eventEnd").val(date.add(1, "hours").format("YYYY-MM-DDTHH:mm")); // Añadimos 1 hora al final por defecto

    // Ocultamos el botón de eliminar, ya que estamos creando un nuevo evento
    $("#deleteEventBtn").hide();
  },
});

// Manejar el formulario de creación de eventos
$("#createEventForm").submit(function (event) {
  event.preventDefault();

  const evento = {
    titulo: $("#eventTitle").val(),
    descripcion: $("#eventDescription").val(),
    fecha_inicio: $("#eventStart").val(),
    fecha_fin: $("#eventEnd").val(),
  };

  const token = sessionStorage.getItem("access_token");

  const eventId = $("#createEventForm").data("eventId");

  // Si hay un ID de evento, significa que estamos editando
  if (eventId) {
    // Editar evento
    $.ajax({
      url: `${apiUrlEventos}${eventId}/`,
      type: "PUT",
      headers: {
        Authorization: `Bearer ${token}`,
      },
      data: JSON.stringify(evento),
      contentType: "application/json",
      success: function (data) {
        $("#createEventModal").modal("hide");
        $("#calendar").fullCalendar("refetchEvents"); // Recargar los eventos
      },
      error: function (xhr, status, error) {
        alert("Error al editar el evento: " + error);
      },
    });
  } else {
    // Crear evento nuevo
    $.ajax({
      url: apiUrlEventos,
      type: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
      },
      data: JSON.stringify(evento),
      contentType: "application/json",
      success: function (data) {
        $("#createEventModal").modal("hide");
        $("#calendar").fullCalendar("refetchEvents"); // Recargar los eventos
      },
      error: function (xhr, status, error) {
        alert("Error al crear el evento: " + error);
      },
    });
  }
});

// Manejar la eliminación de eventos
$("#deleteEventBtn").click(function () {
  const eventId = $("#createEventForm").data("eventId");

  if (eventId) {
    const token = sessionStorage.getItem("access_token");

    // Confirmar la eliminación
    if (confirm("¿Estás seguro de que deseas eliminar este evento?")) {
      $.ajax({
        url: `${apiUrlEventos}${eventId}/`,
        type: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
        success: function (data) {
          $("#createEventModal").modal("hide");
          $("#calendar").fullCalendar("refetchEvents"); // Recargar los eventos
        },
        error: function (xhr, status, error) {
          alert("Error al eliminar el evento: " + error);
        },
      });
    }
  }
});

        // Manejar el formulario de creación de eventos
        $("#createEventForm").submit(function (event) {
          event.preventDefault();

          const evento = {
            equipo1: $("#equipo1").val(),
            equipo2: $("#equipo2").val(),
            descripcion: $("#eventDescription").val(),
            fecha: $("#eventDate").val(),
          };

          const token = sessionStorage.getItem("access_token");

          $.ajax({
            url: apiUrlEventos, // Asume que tienes el API configurado
            type: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            data: JSON.stringify(evento),
            contentType: "application/json",
            success: function (data) {
              $("#createEventModal").modal("hide");
              $("#calendar").fullCalendar("refetchEvents"); // Recargar los eventos
            },
            error: function (xhr, status, error) {
              alert("Error al crear el evento: " + error);
            },
          });
        });
      });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
