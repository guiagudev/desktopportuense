<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Eventos</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FullCalendar Styles -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.css"
      rel="stylesheet"
    />

    <!-- jQuery y FullCalendar Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/fullcalendar.min.js"></script>

    <!-- FullCalendar Español (es) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.2.0/dist/locale/es.js"></script>

    <style>
      #calendar {
        width: 80%;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <header class="card-header">
      <a href="jugadores.html">Volver al listado de Jugadores</a>
    </header>

    <!-- Contenedor para el Calendario -->
    <div class="container">
      <h1 class="my-4 text-center">Calendario de Partidos</h1>
      <div id="calendar"></div>
    </div>

    <!-- Modal para crear evento -->
    <div
      id="createEventModal"
      class="modal fade"
      tabindex="-1"
      role="dialog"
      aria-labelledby="createEventModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createEventModalLabel">Crear Evento</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createEventForm">
              <div class="mb-3">
                <label for="eventTitle" class="form-label"
                  >Título del Evento</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="eventTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="eventDescription" class="form-label"
                  >Descripción</label
                >
                <textarea
                  class="form-control"
                  id="eventDescription"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="eventStart" class="form-label"
                  >Fecha de Inicio</label
                >
                <input
                  type="datetime-local"
                  class="form-control"
                  id="eventStart"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="eventEnd" class="form-label">Fecha de Fin</label>
                <input
                  type="datetime-local"
                  class="form-control"
                  id="eventEnd"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Crear Evento
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const apiUrlEventos = "http://127.0.0.1:8000/api/eventos/";
      $(document).ready(function () {
        $("#calendar").fullCalendar({
          locale: "es", // Configuración del idioma en español
          header: {
            left: "prev,next today",
            center: "title",
            right: "month,agendaWeek,agendaDay",
          },
          events: async function (start, end, timezone, callback) {
            try {
              const token = await window.api.getToken(); // Asume que tienes esta función para obtener el token
              const response = await fetch(apiUrlEventos, {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: token ? `Bearer ${token}` : "",
                },
              });

              if (!response.ok) {
                throw new Error("Error al cargar los eventos");
              }

              const data = await response.json();

              const eventos = data.map((evento) => ({
                title: evento.titulo,
                start: evento.fecha_inicio,
                end: evento.fecha_fin,
                description: evento.descripcion,
                id: evento.id,
              }));

              callback(eventos);
            } catch (error) {
              console.error("Error al cargar los eventos:", error);
            }
          },
          eventClick: function (event) {
            alert(
              `Evento: ${event.titulo}\nDescripción: ${event.descripcion}\nFecha Inicio: ${event.start}\nFecha Fin: ${event.end}`
            );
          },
          editable: true,
          droppable: true,
          dayClick: function (date, jsEvent, view) {
            // Abrir el modal cuando se haga clic en un día
            $("#createEventModal").modal("show");

            // Rellenar automáticamente la fecha de inicio y fin con el día clicado
            $("#eventStart").val(date.format("YYYY-MM-DDTHH:mm"));
            $("#eventEnd").val(date.add(1, "hours").format("YYYY-MM-DDTHH:mm")); // Añadir 1 hora al final por defecto
          },
        });

        // Manejar el formulario de creación de eventos
        $("#createEventForm").submit(function (event) {
          event.preventDefault();

          const evento = {
            titulo: $("#eventTitle").val(), // Cambiar "title" por "titulo"
            descripcion: $("#eventDescription").val(), // Cambiar "description" por "descripcion"
            fecha_inicio: $("#eventStart").val(), // Cambiar "start" por "fecha_inicio"
            fecha_fin: $("#eventEnd").val(), // Cambiar "end" por "fecha_fin"
          };

          const token = sessionStorage.getItem("access_token");

          $.ajax({
            url: apiUrlEventos, // Asume que tienes el API configurado
            type: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            data: JSON.stringify(evento),
            contentType: "application/json",
            success: function (data) {
              $("#createEventModal").modal("hide");
              $("#calendar").fullCalendar("refetchEvents"); // Recargar los eventos
            },
            error: function (xhr, status, error) {
              alert("Error al crear el evento: " + error);
            },
          });
        });$.ajax({
    url: apiUrlEventos,
    type: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    },
    data: JSON.stringify(evento),
    success: function(data) {
        $('#createEventModal').modal('hide');
        $('#calendar').fullCalendar('refetchEvents'); // Recargar los eventos
    },
    error: function(xhr, status, error) {
        console.error('Error al crear el evento:', xhr.responseText);
        alert('Error al crear el evento: ' + xhr.responseText);
    }
});
      });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
